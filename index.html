<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>YPC HELP Desk</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<style>
:root {
    --primary-color: #2e59a7;
    --secondary-color: #3b82f6;
    --success-color: #10b981;
    --warning-color: #facc15;
    --danger-color: #ef4444;
    --inprogress-color: #f97316;
    --background-light: #f3f4f6;
    --surface-color: #ffffff;
    --text-dark: #1f2937;
    --text-muted: #6b7280;
    --border-color: #e5e7eb;
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:"Sarabun",sans-serif;background:var(--background-light);color:var(--text-dark);line-height:1.6;display:flex;}

/* ===== Sidebar ===== */
.sidebar {
    position: fixed;
    left: 0;
    top: 0;
    height: 100vh;
    width: 70px; /* Mini mode */
    background: #1e293b;
    padding: 15px 10px;
    transition: width 0.3s ease;
    overflow: hidden;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
}
.sidebar.open {width: 220px;}

/* ===== Logo ===== */
.sidebar .logo {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 1rem;
}
.sidebar .logo img {
    width: 40px;           /* ขนาดตอน sidebar ปิด */
    height: 40px;
    object-fit: contain;
    transition: width 0.3s, height 0.3s;
}
.sidebar.open .logo img {
    width: 120px;          /* ขนาดตอน sidebar ขยาย */
    height: 120px;
}

.sidebar .toggle-btn {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 40px;
    width: 40px;
    background: #334155;
    border-radius: 10px;
    color: #fff;
    cursor: pointer;
    margin-bottom: 20px;
    font-size: 20px;
    transition: 0.3s;
}
.sidebar .toggle-btn:hover {background: #475569;}
.sidebar ul {list-style: none;padding: 0;width: 100%;}
.sidebar ul li {margin: 10px 0;}
.sidebar ul li a {
    display: flex;align-items: center;gap: 12px;
    color: #e2e8f0;text-decoration: none;
    font-size: 16px;padding: 10px;border-radius: 8px;
    transition: background 0.3s;
    white-space: nowrap;
}
.sidebar ul li a:hover {background: #475569;}
.sidebar ul li a i {font-size: 20px;min-width: 25px;text-align: center;}
.menu-text {display: none;}
.sidebar.open .menu-text {display: inline;}

/* ===== Main Content ===== */
.main-content {
    flex: 1;
    margin-left: 70px;
    padding: 20px;
    transition: margin-left 0.3s ease;
    width: calc(100% - 70px);
}
.sidebar.open ~ .main-content {
    margin-left: 220px;
    width: calc(100% - 220px);
}

/* ===== Header ===== */
header {
    background: var(--primary-color);
    color:#fff;
    padding:1rem 1.5rem;
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    border-radius: 10px;
    margin-bottom: 1rem;
}
header h1{font-size:1.5rem;font-weight:700;}
nav{display:flex;align-items:center;gap:1rem;}
nav a{color:rgba(255,255,255,0.85);text-decoration:none;font-weight:500;padding:0.5rem 0.75rem;border-radius:6px;transition:0.3s;}
nav a:hover{background:rgba(255,255,255,0.2);}

.container{max-width:1200px;margin:0 auto;padding:0 1rem;}
.section-header{font-size:1.5rem;font-weight:700;margin:1.5rem 0;display:flex;align-items:center;gap:0.5rem;}
.dashboard-content{display:flex;flex-wrap:wrap;gap:1.5rem;justify-content:center;align-items:flex-start;}
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;width:100%;}
.card{background:var(--surface-color);border-radius:12px;padding:1rem 1.2rem;text-align:center;box-shadow:var(--shadow-md);transition:0.3s;}
.card:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg);}
.card h3{font-size:0.9rem;margin-bottom:0.3rem;color:var(--text-muted);}
.card p{font-size:1.8rem;font-weight:bold;color:var(--primary-color);}
.summary-card{display:flex;align-items:center;gap:0.75rem;text-align:left;}
.summary-card i{font-size:2rem;color:var(--secondary-color);}
table{width:100%;border-collapse:collapse;background:var(--surface-color);border-radius:12px;overflow:hidden;box-shadow:var(--shadow-md);margin-top:1rem;font-size:0.9rem;}
th,td{padding:0.75rem;border-bottom:1px solid var(--border-color);text-align:center;vertical-align: middle;}
th{background:#e2e8f0;font-weight:600;}
tr:hover{background:#f8fafc;}
.status-badge{display:inline-block;padding:0.35rem 0.65rem;border-radius:999px;font-size:0.75rem;font-weight:600;color:#fff;}
.status-pending{background:var(--warning-color);}
.status-inprogress{background:var(--inprogress-color);}
.status-completed{background:var(--success-color);}
.action-cell{display:flex;justify-content:center;gap:0.5rem;flex-wrap:wrap;}
.btn-action{padding:0.35rem 0.7rem;border:none;border-radius:6px;cursor:pointer;font-size:0.75rem;font-weight:500;transition:0.2s;}
.btn-assign{background:var(--inprogress-color);color:#fff;}
.btn-complete{background:var(--success-color);color:#fff;}
.btn-delete{background:var(--danger-color);color:#fff;}
.btn-edit{background:var(--secondary-color);color:#fff;}
.btn-remark{background:var(--warning-color);color:#000;}
.btn-assign:hover{background:#ea580c;}
.btn-complete:hover{background:#059669;}
.btn-delete:hover{background:#dc2626;}
.btn-edit:hover{background:#2563eb;}
.btn-remark:hover{background:#eab308;}
.pie-chart-container{background:var(--surface-color);border-radius:12px;padding:1.5rem;box-shadow:var(--shadow-md);width:100%;max-width:360px;margin:auto;}
.pie-chart-container h3{text-align:center;font-size:1rem;margin-bottom:0.5rem;}
.pie-chart{width:140px;height:140px;border-radius:50%;margin:1rem auto;position:relative;}
.pie-chart::before{content:'';position:absolute;top:50%;left:50%;width:60px;height:60px;background:var(--background-light);border-radius:50%;transform:translate(-50%,-50%);}
.legend{list-style:none;margin-top:1rem;font-size:0.85rem;}
.legend-item{display:flex;justify-content:space-between;margin-bottom:0.5rem;}
.legend-color{width:0.8rem;height:0.8rem;border-radius:4px;margin-right:0.5rem;}
@media(max-width:768px){
    .dashboard-content{flex-direction:column;align-items:center;}
    .dashboard-grid{grid-template-columns:1fr;}
    table, th, td{font-size:0.8rem;}
    .btn-action{padding:0.3rem 0.5rem;font-size:0.7rem;}
}
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="logo"><img src="YPC.png" alt="Company Logo"></div>
  <div class="toggle-btn" id="toggleBtn"><i class="fas fa-bars"></i></div>
  <ul>
    <li><a href="#" onclick="showPage('dashboard')"><i class="fas fa-home"></i><span class="menu-text">Dashboard</span></a></li>
    <li><a href="#" onclick="showPage('list')"><i class="fas fa-clipboard-list"></i><span class="menu-text">รายการแจ้งซ่อม</span></a></li>
  </ul>
</div>

<!-- Main -->
<div class="main-content">
<header>
    <h1>IT Help Desk</h1>
</header>

<div class="container">

    <section id="dashboardPage">
        <div class="dashboard-content">
            <div class="pie-chart-container">
                <h3>สถานะการแจ้งซ่อม</h3>
                <div class="pie-chart" id="statusPieChart"></div>
                <ul class="legend">
                    <li class="legend-item"><span class="legend-color" style="background:#facc15;"></span> รอดำเนินการ <span id="legendPending"></span></li>
                    <li class="legend-item"><span class="legend-color" style="background:#f97316;"></span> กำลังดำเนินการ <span id="legendInProgress"></span></li>
                    <li class="legend-item"><span class="legend-color" style="background:#10b981;"></span> ดำเนินการแล้ว <span id="legendDone"></span></li>
                </ul>
            </div>
            <div class="dashboard-grid">
                <div class="card summary-card"><i class="fas fa-list-check"></i><div><h3>งานทั้งหมด</h3><p id="totalCount">0</p></div></div>
                <div class="card summary-card"><i class="fas fa-clock"></i><div><h3>รอดำเนินการ</h3><p id="pendingCount">0</p></div></div>
                <div class="card summary-card"><i class="fas fa-hammer"></i><div><h3>กำลังดำเนินการ</h3><p id="inProgressCount">0</p></div></div>
                <div class="card summary-card"><i class="fas fa-circle-check"></i><div><h3>ดำเนินการแล้ว</h3><p id="doneCount">0</p></div></div>
            </div>
        </div>
    </section>

    <!-- เพิ่ม Date Filter ข้างบนตาราง -->
<section id="listPage" style="display:none;">
    <h2 class="section-header"><i class="fas fa-clipboard-list"></i> รายการแจ้งซ่อมทั้งหมด</h2>

    <div style="margin-bottom:1rem;">
        <label for="dateFilter">เลือกวันที่: </label>
        <input type="date" id="dateFilter">
        <button id="applyFilterBtn" onclick="filterData()">ตกลง</button>
        <button id="resetFilterBtn" onclick="resetFilter()">รีเซ็ต</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>ชื่อผู้แจ้ง</th>
                <th>แผนก</th>
                <th>ปัญหา</th>
                <th>รูปภาพ</th>
                <th>วันที่</th>
                <th>สถานะ</th>
                <th>การจัดการ</th>
            </tr>
        </thead>
        <tbody id="repairList"></tbody>
    </table>
</section>

</div>
</div>

<script>
const sidebar = document.getElementById("sidebar");
const toggleBtn = document.getElementById("toggleBtn");
toggleBtn.addEventListener("click",()=>{ sidebar.classList.toggle("open"); });

const API_URL = "https://script.google.com/macros/s/AKfycbw19j5rvmQctUEVrYOdMpZ58kIgiQXvKgvFOzJE-dDGI9tmZKP15swyPlOCWs7x_w0k/exec";
const SECRET_KEY = "YOUR_SECRET_KEY";
const itStaff = ["ไอที1","ไอที2","ไอที3"];

function showPage(pageId){
    document.getElementById("dashboardPage").style.display = pageId==="dashboard"?"block":"none";
    document.getElementById("listPage").style.display = pageId==="list"?"block":"none";
    if(pageId==="dashboard"||pageId==="list"){ loadData(); }
}
async function loadData(){
    try{
        const res = await fetch(`${API_URL}?key=${SECRET_KEY}`);
        const data = await res.json();
        const tbody = document.getElementById("repairList");
        tbody.innerHTML="";
        let total=0,pending=0,inprogress=0,completed=0;

        data.forEach(row=>{
            total++;
            if(row.status==="Pending") pending++;
            else if(row.status==="InProgress") inprogress++;
            else if(row.status==="Completed") completed++;

            const statusClass=row.status==="Pending"?"status-pending":row.status==="InProgress"?"status-inprogress":"status-completed";
            const statusText=row.status==="Pending"?"รอดำเนินการ":row.status==="InProgress"?"กำลังดำเนินการ":"ดำเนินการแล้ว";

            const tr=document.createElement("tr");
            tr.innerHTML=`
                <td>${row.name}</td>
                <td>${row.department}</td>
                <td>${row.issue}</td>
                <td>${row.imageUrl?`<img src="${row.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">`:'ไม่มีรูป'}</td>
                <td>${row.date}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <div class="action-cell">
                        <select onchange="assignCase('${row.employeeID}',this.value)">
                            <option value="">รับเคส</option>
                            ${itStaff.map(staff=>`<option value="${staff}">${staff}</option>`).join('')}
                        </select>
                        <button class="btn-action btn-complete" onclick="updateStatus('${row.employeeID}','Completed')">เสร็จสิ้น</button>
                        <button class="btn-action btn-edit" onclick="editRow('${row.employeeID}','${row.issue}')">แก้ไข</button>
                        <button class="btn-action btn-remark" onclick="addRemark('${row.employeeID}','${row.remark||''}')">Remark</button>
                        <button class="btn-action btn-delete" onclick="deleteRow('${row.employeeID}')">ลบ</button>
                    </div>
                </td>`;
            tbody.appendChild(tr);
        });

        document.getElementById("totalCount").innerText=total;
        document.getElementById("pendingCount").innerText=pending;
        document.getElementById("inProgressCount").innerText=inprogress;
        document.getElementById("doneCount").innerText=completed;

        const pie=document.getElementById("statusPieChart");
        if(total>0){
            let p=(pending/total)*100,i=(inprogress/total)*100,c=(completed/total)*100;
            pie.style.background=`conic-gradient(#facc15 0% ${p}%, #f97316 ${p}% ${p+i}%, #10b981 ${p+i}% 100%)`;
        } else { pie.style.background=`conic-gradient(#eee 100%)`; }
        document.getElementById("legendPending").innerText=`${pending} (${total>0?(pending/total*100).toFixed(0):0}%)`;
        document.getElementById("legendInProgress").innerText=`${inprogress} (${total>0?(inprogress/total*100).toFixed(0):0}%)`;
        document.getElementById("legendDone").innerText=`${completed} (${total>0?(completed/total*100).toFixed(0):0}%)`;
    }catch(e){console.error(e);}
}
function updateStatus(employeeID,newStatus,assignedTo=""){
    fetch(API_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:SECRET_KEY,action:"update",employeeID,status:newStatus,assignedTo})});
    loadData();
}
function assignCase(employeeID,staff){ if(!staff) return; updateStatus(employeeID,"InProgress",staff); }
function editRow(employeeID,oldIssue){
    const newIssue=prompt("แก้ไขปัญหา:",oldIssue);
    if(!newIssue) return;
    fetch(API_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:SECRET_KEY,action:"edit",employeeID,issue:newIssue})});
    loadData();
}
function addRemark(employeeID,oldRemark){
    const newRemark=prompt("เพิ่ม/แก้ไข Remark:",oldRemark);
    if(newRemark===null) return;
    fetch(API_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:SECRET_KEY,action:"remark",employeeID,remark:newRemark})});
    loadData();
}
function deleteRow(employeeID){
    if(!confirm("คุณต้องการลบรายการนี้หรือไม่?")) return;
    fetch(API_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:SECRET_KEY,action:"delete",employeeID})});
    loadData();
}
loadData();
setInterval(loadData,3000);
</script>
</body>
</html>
